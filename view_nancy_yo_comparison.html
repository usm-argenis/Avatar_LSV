<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparaci√≥n: Video yo.mp4 vs Nancy Animada</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .header {
            background: #2a2a2a;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0 0 10px 0;
        }
        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 2px solid #3a3a3a;
        }
        .panel:last-child {
            border-right: none;
        }
        .panel-header {
            background: #2a2a2a;
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #3a3a3a;
        }
        .panel-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: #000;
        }
        #video-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        video {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
        }
        #canvas3d {
            width: 100%;
            height: 100%;
        }
        .controls {
            background: #2a2a2a;
            padding: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #3a8eef;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .status {
            background: #2a2a2a;
            padding: 10px 20px;
            text-align: center;
            font-size: 12px;
            color: #aaa;
        }
        .info-box {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 200px;
        }
        .warning {
            background: #ff6b35;
            color: white;
            padding: 15px;
            margin: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .success {
            background: #4a9eff;
            color: white;
            padding: 15px;
            margin: 10px;
            border-radius: 5px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé≠ Comparaci√≥n de Animaci√≥n</h1>
            <p>Video Original vs Nancy con Movimiento Real de MediaPipe</p>
        </div>
        
        <div class="content">
            <!-- Panel Izquierdo: Video Original -->
            <div class="panel">
                <div class="panel-header">
                    <h2>üìπ Video Original (yo.mp4)</h2>
                </div>
                <div class="panel-content">
                    <div id="video-container">
                        <video id="original-video" loop controls>
                            <source src="test/output/videos/yo.mp4" type="video/mp4">
                            No se pudo cargar el video
                        </video>
                    </div>
                    <div class="info-box" id="video-info">
                        Cargando video...
                    </div>
                </div>
            </div>
            
            <!-- Panel Derecho: Modelo 3D -->
            <div class="panel">
                <div class="panel-header">
                    <h2>üé® Nancy Animada (nancy_yo_real.glb)</h2>
                </div>
                <div class="panel-content">
                    <canvas id="canvas3d"></canvas>
                    <div class="info-box" id="model-info">
                        Cargando modelo...
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button id="play-btn">‚ñ∂Ô∏è Reproducir Ambos</button>
            <button id="pause-btn">‚è∏Ô∏è Pausar</button>
            <button id="reset-btn">üîÑ Reiniciar</button>
            <button id="sync-btn">üîó Sincronizar</button>
        </div>
        
        <div class="status" id="status">
            Listo para reproducir
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // Referencias DOM
        const video = document.getElementById('original-video');
        const canvas = document.getElementById('canvas3d');
        const videoInfo = document.getElementById('video-info');
        const modelInfo = document.getElementById('model-info');
        const status = document.getElementById('status');
        
        const playBtn = document.getElementById('play-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const syncBtn = document.getElementById('sync-btn');

        // Three.js setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a1a);
        
        const camera = new THREE.PerspectiveCamera(50, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
        camera.position.set(0, 1.6, 3);
        
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        renderer.shadowMap.enabled = true;
        
        // Luces
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 10, 7.5);
        directionalLight.castShadow = true;
        scene.add(directionalLight);
        
        const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
        fillLight.position.set(-5, 0, -5);
        scene.add(fillLight);
        
        // Controles
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.target.set(0, 1.6, 0);
        
        // Grid
        const gridHelper = new THREE.GridHelper(10, 10, 0x444444, 0x222222);
        scene.add(gridHelper);

        // Variables globales
        let model = null;
        let mixer = null;
        let animationAction = null;
        const clock = new THREE.Clock();

        // Cargar modelo GLB
        const loader = new GLTFLoader();
        
        modelInfo.innerHTML = '‚è≥ Cargando nancy_yo_real.glb...';
        
        loader.load(
            'nancy_yo_real.glb',
            (gltf) => {
                model = gltf.scene;
                scene.add(model);
                
                // Centrar modelo
                const box = new THREE.Box3().setFromObject(model);
                const center = box.getCenter(new THREE.Vector3());
                model.position.sub(center);
                model.position.y += (box.max.y - box.min.y) / 2;
                
                // Configurar animaci√≥n
                if (gltf.animations && gltf.animations.length > 0) {
                    mixer = new THREE.AnimationMixer(model);
                    animationAction = mixer.clipAction(gltf.animations[0]);
                    animationAction.play();
                    
                    const duration = gltf.animations[0].duration;
                    modelInfo.innerHTML = `
                        ‚úÖ Modelo cargado<br>
                        Animaci√≥n: ${gltf.animations[0].name}<br>
                        Duraci√≥n: ${duration.toFixed(2)}s<br>
                        Huesos: ${gltf.animations[0].tracks.length}
                    `;
                    
                    console.log('Animaci√≥n cargada:', gltf.animations[0]);
                    console.log('Tracks:', gltf.animations[0].tracks.length);
                    
                    // Analizar tracks
                    const boneNames = new Set();
                    gltf.animations[0].tracks.forEach(track => {
                        const boneName = track.name.split('.')[0];
                        boneNames.add(boneName);
                    });
                    
                    console.log('Huesos animados:', Array.from(boneNames).sort());
                    
                } else {
                    modelInfo.innerHTML = '‚ö†Ô∏è Modelo sin animaci√≥n';
                    console.warn('No se encontraron animaciones en el GLB');
                }
                
                status.textContent = '‚úÖ Todo cargado - Listo para reproducir';
            },
            (progress) => {
                const percent = (progress.loaded / progress.total * 100).toFixed(0);
                modelInfo.innerHTML = `‚è≥ Cargando... ${percent}%`;
            },
            (error) => {
                console.error('Error al cargar GLB:', error);
                modelInfo.innerHTML = `‚ùå Error: ${error.message}`;
                status.textContent = '‚ùå Error al cargar el modelo';
            }
        );

        // Info del video
        video.addEventListener('loadedmetadata', () => {
            videoInfo.innerHTML = `
                ‚úÖ Video cargado<br>
                Duraci√≥n: ${video.duration.toFixed(2)}s<br>
                FPS: ~30<br>
                Resoluci√≥n: ${video.videoWidth}x${video.videoHeight}
            `;
        });

        // Controles
        playBtn.addEventListener('click', () => {
            video.play();
            if (mixer && animationAction) {
                animationAction.paused = false;
            }
            status.textContent = '‚ñ∂Ô∏è Reproduciendo';
        });

        pauseBtn.addEventListener('click', () => {
            video.pause();
            if (animationAction) {
                animationAction.paused = true;
            }
            status.textContent = '‚è∏Ô∏è Pausado';
        });

        resetBtn.addEventListener('click', () => {
            video.currentTime = 0;
            video.pause();
            if (mixer && animationAction) {
                animationAction.stop();
                animationAction.play();
                animationAction.paused = true;
            }
            status.textContent = 'üîÑ Reiniciado';
        });

        syncBtn.addEventListener('click', () => {
            if (mixer && animationAction && video.duration) {
                // Sincronizar basado en el tiempo del video
                const videoProgress = video.currentTime / video.duration;
                const animDuration = animationAction.getClip().duration;
                animationAction.time = videoProgress * animDuration;
                status.textContent = 'üîó Sincronizado';
            }
        });

        // Loop de animaci√≥n
        function animate() {
            requestAnimationFrame(animate);
            
            const delta = clock.getDelta();
            
            if (mixer) {
                mixer.update(delta);
            }
            
            controls.update();
            renderer.render(scene, camera);
        }
        
        animate();

        // Resize handler
        window.addEventListener('resize', () => {
            const width = canvas.clientWidth;
            const height = canvas.clientHeight;
            
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        });

        // Debug: Mostrar estado cada segundo
        setInterval(() => {
            if (mixer && animationAction) {
                console.log('Animation time:', animationAction.time.toFixed(2), 
                           'Video time:', video.currentTime.toFixed(2));
            }
        }, 1000);
    </script>
</body>
</html>
