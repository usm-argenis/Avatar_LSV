<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Diagn√≥stico - Sistema Gestos Faciales</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a2e;
            color: #43e97b;
            padding: 20px;
        }
        .log { margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; }
        .error { color: #ff6b6b; }
        .success { color: #43e97b; }
        .warning { color: #feca57; }
        .info { color: #48dbfb; }
        h1 { color: #f093fb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico del Sistema de Gestos Faciales</h1>
    
    <div>
        <button onclick="testStep1()">1. Cargar Config JSON</button>
        <button onclick="testStep2()">2. Cargar Modelo Luis</button>
        <button onclick="testStep3()">3. Inicializar Sistema</button>
        <button onclick="testStep4()">4. Aplicar Expresi√≥n</button>
        <button onclick="testStep5()">5. Verificar Morph Targets</button>
        <button onclick="clearLogs()">Limpiar</button>
    </div>
    
    <div id="logs"></div>
    
    <canvas id="canvas-3d" style="display:none;"></canvas>

    <script src="facial_expression_system.js"></script>
    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js';
        import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/loaders/GLTFLoader.js';

        let facialSystem;
        let luisModel;
        let scene, camera, renderer;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log ${type}`;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            console.log(message);
        }

        window.clearLogs = function() {
            document.getElementById('logs').innerHTML = '';
        };

        window.testStep1 = async function() {
            log('üîÑ Paso 1: Cargando configuraci√≥n JSON...', 'info');
            
            try {
                const response = await fetch('facial_expressions_config.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const config = await response.json();
                log(`‚úÖ Config cargado. Expresiones: ${Object.keys(config.expressions).length}`, 'success');
                log(`   Expresiones: ${Object.keys(config.expressions).join(', ')}`, 'info');
                
                // Verificar una expresi√≥n
                const angryConfig = config.expressions.angry;
                log(`   Ejemplo "angry": ${Object.keys(angryConfig.morphTargets).length} shape keys`, 'info');
                log(`   Shape keys: ${Object.keys(angryConfig.morphTargets).join(', ')}`, 'info');
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        };

        window.testStep2 = async function() {
            log('üîÑ Paso 2: Cargando modelo Luis.glb...', 'info');
            
            if (!scene) {
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
                renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas-3d') });
            }
            
            try {
                const loader = new GLTFLoader();
                const gltf = await new Promise((resolve, reject) => {
                    loader.load('output/glb/Luis/Luis.glb', resolve, undefined, reject);
                });
                
                luisModel = gltf.scene;
                log('‚úÖ Modelo cargado exitosamente', 'success');
                
                // Analizar meshes
                let meshCount = 0;
                let morphTargetCount = 0;
                luisModel.traverse((child) => {
                    if (child.isMesh) {
                        meshCount++;
                        if (child.morphTargetInfluences) {
                            morphTargetCount++;
                            log(`   üì¶ Mesh: ${child.name} - ${child.morphTargetInfluences.length} morph targets`, 'info');
                            
                            if (child.morphTargetDictionary) {
                                const targets = Object.keys(child.morphTargetDictionary);
                                log(`      Primeros 10: ${targets.slice(0, 10).join(', ')}`, 'info');
                            }
                        }
                    }
                });
                
                log(`‚úÖ Total: ${meshCount} meshes, ${morphTargetCount} con morph targets`, 'success');
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        };

        window.testStep3 = async function() {
            log('üîÑ Paso 3: Inicializando sistema de gestos...', 'info');
            
            if (!luisModel) {
                log('‚ö†Ô∏è Primero ejecuta Paso 2 para cargar el modelo', 'warning');
                return;
            }
            
            try {
                facialSystem = new FacialExpressionSystem();
                await facialSystem.loadConfig('facial_expressions_config.json');
                facialSystem.initializeWithModel(luisModel);
                
                const info = facialSystem.getDebugInfo();
                log(`‚úÖ Sistema inicializado`, 'success');
                log(`   Meshes: ${info.meshCount}`, 'info');
                log(`   Morph targets disponibles: ${info.availableMorphTargets}`, 'info');
                log(`   Expresi√≥n actual: ${info.currentExpression}`, 'info');
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        };

        window.testStep4 = function() {
            log('üîÑ Paso 4: Aplicando expresi√≥n "angry"...', 'info');
            
            if (!facialSystem) {
                log('‚ö†Ô∏è Primero ejecuta Paso 3 para inicializar el sistema', 'warning');
                return;
            }
            
            try {
                facialSystem.setExpression('angry', 0);
                
                const info = facialSystem.getDebugInfo();
                log(`‚úÖ Expresi√≥n aplicada: ${info.currentExpression}`, 'success');
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        };

        window.testStep5 = function() {
            log('üîÑ Paso 5: Verificando valores de morph targets...', 'info');
            
            if (!luisModel || !facialSystem) {
                log('‚ö†Ô∏è Primero ejecuta los pasos anteriores', 'warning');
                return;
            }
            
            try {
                let hasNonZero = false;
                luisModel.traverse((child) => {
                    if (child.isMesh && child.morphTargetInfluences) {
                        log(`   Mesh: ${child.name}`, 'info');
                        
                        for (let i = 0; i < child.morphTargetInfluences.length; i++) {
                            const value = child.morphTargetInfluences[i];
                            if (value > 0) {
                                hasNonZero = true;
                                // Buscar nombre del morph target
                                let targetName = 'unknown';
                                if (child.morphTargetDictionary) {
                                    for (const [name, index] of Object.entries(child.morphTargetDictionary)) {
                                        if (index === i) {
                                            targetName = name;
                                            break;
                                        }
                                    }
                                }
                                log(`      [${i}] ${targetName}: ${value.toFixed(3)}`, 'success');
                            }
                        }
                    }
                });
                
                if (!hasNonZero) {
                    log('‚ö†Ô∏è Ning√∫n morph target tiene valor > 0', 'warning');
                    log('   Esto indica que la expresi√≥n NO se est√° aplicando', 'error');
                } else {
                    log('‚úÖ Expresi√≥n aplicada correctamente', 'success');
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        };
        
        // Log inicial
        log('Sistema de diagn√≥stico listo. Ejecuta los pasos en orden.', 'info');
    </script>
</body>
</html>
