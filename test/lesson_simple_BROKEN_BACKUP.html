<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecci√≥n Simple - LSV</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            color: white;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #viewer-container {
            flex: 1;
            position: relative;
            background: linear-gradient(180deg, #1a1a2e 0%, #2d2d44 100%);
        }

        #canvas-3d {
            width: 100%;
            height: 100%;
        }

        .status {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            z-index: 50;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #loading.hidden {
            display: none;
        }

        .spinner {
            width: 70px;
            height: 70px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 25px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 20px;
            color: #667eea;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="viewer-container">
        <canvas id="canvas-3d"></canvas>
        <div class="status" id="status">Cargando...</div>
    </div>

    <div id="loading">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-text">Cargando...</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/examples/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';

        let scene, camera, renderer, controls, clock;
        let avatarModel, mixer, currentAction;
        
        // Obtener par√°metros desde URL
        const params = new URLSearchParams(window.location.search);
        const avatarName = params.get('avatar') || 'luis';
        const letraParam = params.get('letra') || params.get('text') || 'a';
        const autoplay = params.get('autoplay') !== 'false';

        async function init() {
            setupScene();
            await cargarAvatar(avatarName);
            await cargarYReproducirAnimacion(letraParam);
            setupEventListeners();
            animate();
        }

        function setupScene() {
            const container = document.getElementById('viewer-container');
            const canvas = document.getElementById('canvas-3d');
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);
            
            camera = new THREE.PerspectiveCamera(
                50,
                container.clientWidth / container.clientHeight,
                0.1,
                1000
            );
            camera.position.set(0, 1.6, 3);
            
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas,
                antialias: true
            });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            controls = new OrbitControls(camera, canvas);
            controls.target.set(0, 1.2, 0);
            controls.update();
            
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 5);
            scene.add(directionalLight);
            
            const backLight = new THREE.DirectionalLight(0x667eea, 0.4);
            backLight.position.set(-5, 5, -5);
            scene.add(backLight);
            
            clock = new THREE.Clock();
            
            window.addEventListener('resize', () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });
        }

        async function cargarAvatar(nombreAvatar) {
            const loader = new GLTFLoader();
            const loadingText = document.getElementById('loading-text');
            const loadingDiv = document.getElementById('loading');
            
            loadingDiv.classList.remove('hidden');
            loadingText.textContent = `Cargando ${nombreAvatar}...`;
            
            const genero = (nombreAvatar === 'nancy' || nombreAvatar === 'nina') ? 'Mujer' : 'Hombre';
            const rutasIntento = [
                `output/glb/${nombreAvatar}/${nombreAvatar}.glb`,
                `output/glb/${genero}/${nombreAvatar}.glb`
            ];
            
            let cargado = false;
            
            for (const ruta of rutasIntento) {
                if (cargado) break;
                
                try {
                    const gltf = await new Promise((res, rej) => {
                        loader.load(
                            ruta,
                            (result) => res(result),
                            (progress) => {
                                const percent = (progress.loaded / progress.total) * 100;
                                loadingText.textContent = `Cargando ${nombreAvatar}... ${percent.toFixed(0)}%`;
                            },
                            (error) => rej(error)
                        );
                    });
                    
                    avatarModel = gltf.scene;
                    scene.add(avatarModel);
                    
                    const box = new THREE.Box3().setFromObject(avatarModel);
                    const center = box.getCenter(new THREE.Vector3());
                    avatarModel.position.sub(center);
                    avatarModel.position.y = 0;
                    
                    mixer = new THREE.AnimationMixer(avatarModel);
                    
                    loadingDiv.classList.add('hidden');
                    document.getElementById('status').textContent = `‚úÖ ${nombreAvatar} cargado`;
                    
                    cargado = true;
                    console.log(`‚úÖ Avatar ${nombreAvatar} cargado exitosamente`);
                    return;
                    
                } catch (error) {
                    console.log(`No se pudo cargar desde: ${ruta}`);
                }
            }
            
            if (!cargado) {
                document.getElementById('status').textContent = `‚ùå Error al cargar ${nombreAvatar}`;
                loadingDiv.classList.add('hidden');
                throw new Error(`No se pudo cargar ${nombreAvatar}`);
            }
        }

        // Cach√© de animaciones para evitar recargas
        const animationCache = new Map();
        
        async function cargarYReproducirAnimacion(letra) {
            document.getElementById('status').textContent = `üé¨ Mostrando: ${letra.toUpperCase()}`;
            
            const loader = new GLTFLoader();
            const categoria = 'alfabeto';
            const archivo = letra.toLowerCase();
            const cacheKey = `${categoria}_${archivo}`;
            
            // Verificar cach√© primero
            if (animationCache.has(cacheKey)) {
                console.log(`üì¶ Usando animaci√≥n en cach√©: ${letra}`);
                const clip = animationCache.get(cacheKey);
                await reproducirClipDirecto(clip, letra);
                return;
            }
            
            const rutasIntento = [
                `output/glb/${avatarName}/${categoria}/${avatarName}_resultado_${archivo}.glb`,
                `output/glb/${avatarName}/${categoria}/${categoria}_${avatarName}_resultado_${archivo}.glb`,
            ];
            
            for (const ruta of rutasIntento) {
                try {
                    const gltf = await new Promise((resolve, reject) => {
                        loader.load(ruta, resolve, undefined, reject);
                    });
                    
                    console.log(`‚úÖ Animaci√≥n cargada: ${ruta}`);
                    
                    if (gltf.animations && gltf.animations.length > 0) {
                        const clip = gltf.animations[0];
                        
                        // Guardar en cach√©
                        animationCache.set(cacheKey, clip);
                        
                        await reproducirClipDirecto(clip, letra);
                    }
                    
                    return;
                } catch (error) {
                    console.log(`No se encontr√≥ en: ${ruta}`);
                }
            }
            
            document.getElementById('status').textContent = `‚ùå No se encontr√≥ animaci√≥n: ${letra}`;
        }
        
        function reproducirClipDirecto(clip, letra) {
            return new Promise((resolve) => {
                if (currentAction) {
                    currentAction.stop();
                }
                
                const action = mixer.clipAction(clip);
                action.reset();
                action.setLoop(THREE.LoopRepeat);
                action.timeScale = 1.0; // Velocidad normal para fluidez
                action.play();
                
                currentAction = action;
                document.getElementById('status').textContent = `‚ñ∂Ô∏è ${letra.toUpperCase()}`;
                
                // Resolver inmediatamente para eliminar pausas
                resolve();
            });
        }

        function setupEventListeners() {
            // Sin botones - no es necesario
        }

        function animate() {
            requestAnimationFrame(animate);
            
            const delta = clock.getDelta();
            
            if (mixer) {
                mixer.update(delta);
            }
            
            controls.update();
            renderer.render(scene, camera);
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
