<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar Est√°tico LSV</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body {
            overflow: hidden;
            background: #ffffff;
            border: none;
        }

        #app {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
        }

        #canvas-3d {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <div id="app">
        <canvas id="canvas-3d"></canvas>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // Obtener par√°metros de URL
        const params = new URLSearchParams(window.location.search);
        const avatarName = params.get('avatar') || 'Luis';

        // Configuraci√≥n
        const AVATAR_PATHS = {
            'Luis': 'output/glb/Luis/Luis.glb',
            'Duvall': 'output/glb/Duvall/Duvall.glb',
            'Nancy': 'output/glb/Nancy/Nancy.glb',
            'Carla': 'output/glb/Carla/Carla.glb',
            'Argenis': 'output/glb/Argenis/Argenis.glb'
        };

        // Variables globales
        let scene, camera, renderer, avatar;
        const avatarCache = {}; // Cache para avatares ya cargados
        let isLoading = false;

        // Inicializar escena
        function init() {
            // Escena
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff);

            // C√°mara
            camera = new THREE.PerspectiveCamera(
                50,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(0, 1.5, 2.1);
            camera.lookAt(0, 1.3, 1.32);

            // Renderer
            const canvas = document.getElementById('canvas-3d');
            renderer = new THREE.WebGLRenderer({ 
                canvas, 
                antialias: true,
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;

            // Luces
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);

            const directionalLight1 = new THREE.DirectionalLight(0xffffff, 1.2);
            directionalLight1.position.set(5, 5, 5);
            scene.add(directionalLight1);

            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.6);
            directionalLight2.position.set(-5, 3, -5);
            scene.add(directionalLight2);

            const fillLight = new THREE.DirectionalLight(0xffffff, 0.4);
            fillLight.position.set(0, -2, 5);
            scene.add(fillLight);

            // Cargar avatar
            loadAvatar(avatarName);

            // Resize
            window.addEventListener('resize', onResize);

            // Render loop
            animate();
        }

        function loadAvatar(name) {
            // Prevenir cargas m√∫ltiples simult√°neas
            if (isLoading) {
                console.log('‚è≥ Carga en progreso, ignorando...');
                return;
            }

            // Si el avatar ya est√° cargado y en cach√©, solo intercambiarlo
            if (avatarCache[name]) {
                console.log(`‚ö° Usando ${name} desde cach√©`);
                
                if (avatar) {
                    scene.remove(avatar);
                    avatar.visible = false;
                }
                
                avatar = avatarCache[name];
                avatar.visible = true;
                scene.add(avatar);
                return;
            }

            isLoading = true;
            const loader = new GLTFLoader();
            const avatarPath = AVATAR_PATHS[name] || AVATAR_PATHS['Luis'];

            loader.load(
                avatarPath,
                (gltf) => {
                    const newAvatar = gltf.scene;
                    
                    // Configurar avatar
                    newAvatar.position.set(0, 0, 0);
                    newAvatar.rotation.y = 0;
                    
                    const scale = name === 'Nancy' || name === 'Carla' ? 1.0 : 1.0;
                    newAvatar.scale.set(scale, scale, scale);

                    // Optimizar materiales
                    newAvatar.traverse((child) => {
                        if (child.isMesh) {
                            child.frustumCulled = true;
                            if (child.material) {
                                child.material.needsUpdate = false;
                            }
                        }
                    });

                    // Guardar en cach√©
                    avatarCache[name] = newAvatar;

                    // Remover avatar anterior
                    if (avatar) {
                        scene.remove(avatar);
                        avatar.visible = false;
                    }

                    avatar = newAvatar;
                    scene.add(avatar);
                    isLoading = false;

                    console.log(`‚úÖ Avatar ${name} cargado y cacheado`);
                },
                (progress) => {
                    if (progress.total > 0) {
                        const percent = (progress.loaded / progress.total) * 100;
                        console.log(`Cargando ${name}: ${percent.toFixed(0)}%`);
                    }
                },
                (error) => {
                    console.error('‚ùå Error cargando avatar:', error);
                    isLoading = false;
                }
            );
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        // Iniciar
        init();

        // Exponer funci√≥n para cambiar avatar desde fuera
        window.changeAvatar = function(name) {
            loadAvatar(name);
        };

        // Listener para mensajes de React Native WebView
        window.addEventListener('message', function(event) {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'changeAvatar' && data.avatar) {
                    console.log('üì± Mensaje recibido: cambiar a avatar', data.avatar);
                    loadAvatar(data.avatar);
                }
            } catch (e) {
                // Ignorar mensajes mal formados
            }
        });

        // Listener adicional para Android
        document.addEventListener('message', function(event) {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'changeAvatar' && data.avatar) {
                    console.log('üì± Mensaje recibido (Android): cambiar a avatar', data.avatar);
                    loadAvatar(data.avatar);
                }
            } catch (e) {
                // Ignorar mensajes mal formados
            }
        });
    </script>
</body>
</html>
