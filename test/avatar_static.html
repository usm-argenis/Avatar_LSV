<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar Est√°tico LSV - Visor 3D</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body {
            overflow: hidden;
            background: #ffffff;
            border: none;
        }

        #app {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
        }

        #canvas-3d {
            width: 100%;
            height: 100%;
            border: none;
        }

        #loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #2196F3;
            font-family: Arial, sans-serif;
            z-index: 10;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="app">
        <canvas id="canvas-3d"></canvas>
        <div id="loading-indicator">
            <div class="spinner"></div>
            <div id="loading-text">Cargando modelo 3D...</div>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        console.log('üé¨ Avatar Static HTML - Visor de Modelos 3D GLB');
        console.log('üì¶ THREE.js version:', THREE.REVISION);

        // Obtener par√°metros de URL
        const params = new URLSearchParams(window.location.search);
        const avatarName = params.get('avatar') || 'Luis';
        
        console.log('üé≠ Avatar solicitado:', avatarName);

        // Configuraci√≥n de rutas de modelos 3D GLB
        const AVATAR_PATHS = {
            'Luis': 'output/glb/Luis/Luis.glb',
            'Duvall': 'output/glb/Duvall/Duvall.glb',
            'Nancy': 'output/glb/Nancy/Nancy.glb',
            'Carla': 'output/glb/Carla/Carla.glb',
            'Argenis': 'output/glb/Argenis/Argenis.glb'
        };
        
        console.log('üìÇ Rutas de modelos 3D GLB configuradas:', AVATAR_PATHS);
        console.log(`üéØ Ruta del modelo a cargar: ${AVATAR_PATHS[avatarName] || 'NO ENCONTRADA'}`);

        // Variables globales
        let scene, camera, renderer, avatar;
        const avatarCache = {}; // Cache para avatares ya cargados
        let isLoading = false;
        const loader = new GLTFLoader(); // Reutilizar loader
        
        // Configurar loader para mejor rendimiento
        loader.setRequestHeader({ 'Cache-Control': 'max-age=31536000' });

        // Funci√≥n de carga de modelo 3D GLB
        function loadAvatar(name) {
            // Prevenir cargas m√∫ltiples simult√°neas
            if (isLoading) {
                console.warn('‚è≥ Ya hay una carga en progreso');
                return;
            }

            // ‚ö° Si el avatar ya est√° en cach√©, usar inmediatamente (INSTANT√ÅNEO)
            if (avatarCache[name]) {
                console.log(`‚ö° Modelo 3D ${name} desde cach√© - INSTANT√ÅNEO`);
                
                if (avatar && avatar !== avatarCache[name]) {
                    scene.remove(avatar);
                }
                
                avatar = avatarCache[name];
                avatar.visible = true;
                scene.add(avatar);
                hideLoading();
                return;
            }

            // Primera carga desde red
            const avatarPath = AVATAR_PATHS[name] || AVATAR_PATHS['Luis'];
            console.log(`üöÄ Cargando modelo 3D desde: ${avatarPath}`);
            showLoading(`Cargando modelo 3D ${name}...`);
            isLoading = true;
            
            loader.load(
                avatarPath,
                (gltf) => {
                    console.log(`‚úÖ Modelo 3D ${name}.glb cargado exitosamente`);
                    const model = gltf.scene;
                    
                    // Configurar escala
                    const scale = (name === 'Nancy' || name === 'Carla') ? 1.0 : 1.0;
                    model.scale.set(scale, scale, scale);
                    model.position.set(0, 0, 0);
                    model.rotation.y = 0;
                    
                    // Optimizar materiales para alta calidad visual
                    model.traverse((node) => {
                        if (node.isMesh) {
                            node.frustumCulled = true;
                            node.castShadow = false;
                            node.receiveShadow = false;
                            
                            if (node.material) {
                                node.material.metalness = 0.1;
                                node.material.roughness = 0.8;
                                node.material.needsUpdate = true;
                                
                                // Mejorar calidad de texturas
                                if (node.material.map) {
                                    node.material.map.anisotropy = renderer.capabilities.getMaxAnisotropy();
                                    node.material.map.needsUpdate = true;
                                }
                            }
                        }
                    });

                    // Guardar en cach√©
                    avatarCache[name] = model;

                    // Remover avatar anterior
                    if (avatar) {
                        scene.remove(avatar);
                    }

                    avatar = model;
                    scene.add(avatar);
                    isLoading = false;
                    hideLoading();

                    console.log(`‚úÖ Modelo 3D ${name} renderizado en escena`);
                    console.log(`üìä Mallas en el modelo: ${countMeshes(model)}`);
                },
                (progress) => {
                    if (progress.lengthComputable) {
                        const percent = (progress.loaded / progress.total) * 100;
                        showLoading(`Cargando modelo 3D ${name}... ${Math.round(percent)}%`);
                        console.log(`üì• Progreso de carga: ${Math.round(percent)}%`);
                    }
                },
                (error) => {
                    console.error(`‚ùå ERROR cargando modelo 3D ${name}:`, error);
                    console.error(`‚ùå Ruta intentada: ${avatarPath}`);
                    showLoading(`‚ùå Error: No se pudo cargar el modelo 3D ${name}`);
                    isLoading = false;
                    
                    setTimeout(() => {
                        hideLoading();
                    }, 3000);
                }
            );
        }

        // Funci√≥n auxiliar para contar mallas en el modelo 3D
        function countMeshes(object) {
            let count = 0;
            object.traverse((node) => {
                if (node.isMesh) count++;
            });
            return count;
        }

        // Funciones de UI para indicador de carga
        function showLoading(text) {
            const indicator = document.getElementById('loading-indicator');
            const loadingText = document.getElementById('loading-text');
            if (indicator) indicator.classList.remove('hidden');
            if (loadingText) loadingText.textContent = text || 'Cargando modelo 3D...';
        }

        function hideLoading() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) indicator.classList.add('hidden');
        }

        // Inicializar escena 3D
        function init() {
            console.log('üöÄ Inicializando escena 3D con alta calidad visual...');
            
            // Escena
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff);
            console.log('‚úÖ Escena 3D creada');

            // C√°mara
            camera = new THREE.PerspectiveCamera(
                50,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(0, 1.5, 2.1);
            camera.lookAt(0, 1.3, 1.32);
            console.log('‚úÖ C√°mara configurada');

            // Renderer optimizado para WebView m√≥vil con alta calidad
            const canvas = document.getElementById('canvas-3d');
            const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
            
            renderer = new THREE.WebGLRenderer({ 
                canvas, 
                antialias: true,
                alpha: true,
                powerPreference: 'high-performance',
                stencil: false,
                depth: true,
                premultipliedAlpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            renderer.shadowMap.enabled = false;
            
            console.log('‚úÖ Renderer WebGL configurado (alta calidad)');
            console.log(`üì± Dispositivo m√≥vil: ${isMobile ? 'S√≠' : 'No'}`);
            console.log(`üìê Resoluci√≥n: ${window.innerWidth}x${window.innerHeight}`);
            console.log(`üé® PixelRatio: ${window.devicePixelRatio}`);
            console.log(`‚ú® Antialias: activado`);

            // Iluminaci√≥n
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);

            const directionalLight1 = new THREE.DirectionalLight(0xffffff, 1.2);
            directionalLight1.position.set(5, 5, 5);
            scene.add(directionalLight1);

            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.6);
            directionalLight2.position.set(-5, 3, -5);
            scene.add(directionalLight2);

            const fillLight = new THREE.DirectionalLight(0xffffff, 0.4);
            fillLight.position.set(0, -2, 5);
            scene.add(fillLight);
            
            console.log('‚úÖ Iluminaci√≥n configurada (3 luces direccionales + ambiente)');

            // ‚ö° Carga INMEDIATA del modelo 3D GLB
            console.log(`üé≠ Iniciando carga de modelo 3D: ${avatarName}.glb`);
            loadAvatar(avatarName);

            // Resize
            window.addEventListener('resize', onResize);

            // Render loop
            animate();
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Render loop continuo optimizado para WebView m√≥vil
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        // Iniciar aplicaci√≥n
        init();

        // Exponer funci√≥n para cambiar avatar desde fuera
        window.changeAvatar = function(name) {
            if (name && AVATAR_PATHS[name]) {
                console.log(`üîÑ Cambio de modelo 3D solicitado: ${name}`);
                loadAvatar(name);
            } else {
                console.error(`‚ùå Avatar ${name} no existe en AVATAR_PATHS`);
            }
        };

        // Funci√≥n unificada para manejar mensajes de React Native
        function handleAvatarMessage(data) {
            try {
                const message = typeof data === 'string' ? JSON.parse(data) : data;
                
                if (message.type === 'changeAvatar' && message.avatar) {
                    console.log('üì± Cambio de avatar solicitado desde app m√≥vil:', message.avatar);
                    loadAvatar(message.avatar);
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è Mensaje no procesable:', e);
            }
        }

        // Listener para iOS React Native WebView
        window.addEventListener('message', function(event) {
            handleAvatarMessage(event.data);
        });

        // Listener para Android React Native WebView
        document.addEventListener('message', function(event) {
            handleAvatarMessage(event.data);
        });

        // Notificar a React Native que la p√°gina est√° lista
        if (window.ReactNativeWebView) {
            window.ReactNativeWebView.postMessage(JSON.stringify({
                type: 'ready',
                avatar: avatarName
            }));
            console.log('üì≤ Notificaci√≥n de "ready" enviada a React Native');
        }
    </script>
</body>
</html>
